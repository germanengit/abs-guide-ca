<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.8.1: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7056 2011-06-17 10:50:48Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">rst-ca/debugging.ca.rst</tt>, line 1)</p>
<p>Malformed table.</p>
<pre class="literal-block">
+----------------------------------+----+--------------------------+
| Advanced Bash-Scripting Guide:   |
+==================================+====+==========================+
| `Prev &lt;zeros.html&gt;`_             |    | `Next &lt;options.html&gt;`_   |
+----------------------------------+----+--------------------------+
</pre>
</div>
<hr class="docutils" />
<div class="section" id="chapter-32-debugging">
<h1>Chapter 32. Debugging</h1>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a></p>
<div class="system-message" id="id1">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">rst-ca/debugging.ca.rst</tt>, line 12); <em><a href="#id2">backlink</a></em></p>
Inline strong start-string without end-string.</div>
<p><em>Debugging is twice as hard as writing the code in the first place.
Therefore, if you write the code as cleverly as possible, you are, by
definition, not smart enough to debug it.</em></p>
<p><em>--Brian Kernighan</em></p>
<p>The Bash shell contains no built-in debugger, and only bare-bones
debugging-specific commands and constructs. Syntax errors or outright
typos in the script generate cryptic error messages that are often of no
help in debugging a non-functional script.</p>
<p><strong>Example 32-1. A buggy script</strong></p>
<pre class="literal-block">
#!/bin/bash
# ex74.sh

# This is a buggy script.
# Where, oh where is the error?

a=37

if [$a -gt 27 ]
then
  echo $a
fi

exit 0
</pre>
<p>Output from script:</p>
<pre class="literal-block">
./ex74.sh: [37: command not found
</pre>
<p>What's wrong with the above script? Hint: after the <em>if</em>.</p>
<p><strong>Example 32-2. Missing `keyword &lt;internal.html#KEYWORDREF&gt;`_</strong></p>
<pre class="literal-block">
#!/bin/bash
# missing-keyword.sh: What error message will this generate?

for a in 1 2 3
do
  echo &quot;$a&quot;
# done     # Required keyword 'done' commented out in line 7.

exit 0

# === #

echo $?    # 2
</pre>
<p>Output from script:</p>
<pre class="literal-block">
missing-keyword.sh: line 10: syntax error: unexpected end of file
</pre>
<p>Note that the error message does <em>not</em> necessarily reference the line in
which the error occurs, but the line where the Bash interpreter finally
becomes aware of the error.</p>
<p>Error messages may disregard comment lines in a script when reporting
the line number of a syntax error.</p>
<p>What if the script executes, but does not work as expected? This is the
all too familiar logic error.</p>
<p><strong>Example 32-3. *test24*: another buggy script</strong></p>
<pre class="literal-block">
#!/bin/bash

#  This script is supposed to delete all filenames in current directory
#+ containing embedded spaces.
#  It doesn't work.
#  Why not?


badname=`ls | grep ' '`

# Try this:
# echo &quot;$badname&quot;

rm &quot;$badname&quot;

exit 0
</pre>
<p>Try to find out what's wrong with <a class="reference external" href="debugging.html#EX75">Example 32-3</a>
by uncommenting the <tt class="docutils literal">echo &quot;$badname&quot;</tt> line. Echo statements are useful
for seeing whether what you expect is actually what you get.</p>
<p>In this particular case, <tt class="docutils literal">rm &quot;$badname&quot;</tt> will not give the desired
results because <tt class="docutils literal">$badname</tt> should not be quoted. Placing it in quotes
ensures that <strong>rm</strong> has only one argument (it will match only one
filename). A partial fix is to remove to quotes from <tt class="docutils literal">$badname</tt> and to
reset <tt class="docutils literal">$IFS</tt> to contain only a newline, <tt class="docutils literal"><span class="pre">IFS=$'\n'</span></tt>. However, there
are simpler ways of going about it.</p>
<pre class="literal-block">
# Correct methods of deleting filenames containing spaces.
rm *\ *
rm *&quot; &quot;*
rm *' '*
# Thank you. S.C.
</pre>
<p>Summarizing the symptoms of a buggy script,</p>
<ol class="arabic simple">
<li>It bombs with a &quot;syntax error&quot; message, or</li>
<li>It runs, but does not work as expected (logic error).</li>
<li>It runs, works as expected, but has nasty side effects (logic bomb).</li>
</ol>
<p>Tools for debugging non-working scripts include</p>
<ol class="arabic">
<li><p class="first">Inserting <a class="reference external" href="internal.html#ECHOREF">echo</a> statements at critical
points in the script to trace the variables, and otherwise give a
snapshot of what is going on.</p>
<div class="figure align-center">
<img alt="Tip" src="http://tldp.org/LDP/abs/images/tip.gif" />
<p class="caption">Tip</p>
</div>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">rst-ca/debugging.ca.rst</tt>, line 146)</p>
<p>Explicit markup ends without a blank line; unexpected unindent.</p>
</div>
<p>Even better is an <strong>echo</strong> that echoes only when <em>debug</em> is on.</p>
<pre class="literal-block">
### debecho (debug-echo), by Stefano Falsetto ###
### Will echo passed parameters only if DEBUG is set to a value. ###
debecho () {
  if [ ! -z &quot;$DEBUG&quot; ]; then
     echo &quot;$1&quot; &gt;&amp;2
     #         ^^^ to stderr
  fi
}

DEBUG=on
Whatever=whatnot
debecho $Whatever   # whatnot

DEBUG=
Whatever=notwhat
debecho $Whatever   # (Will not echo.)
</pre>
</li>
<li><p class="first">Using the <a class="reference external" href="extmisc.html#TEEREF">tee</a> filter to check processes or
data flows at critical points.</p>
</li>
<li><p class="first">Setting option flags <tt class="docutils literal"><span class="pre">-n</span> <span class="pre">-v</span> <span class="pre">-x</span></tt></p>
<p><tt class="docutils literal">sh <span class="pre">-n</span> scriptname</tt> checks for syntax errors without actually
running the script. This is the equivalent of inserting <tt class="docutils literal">set <span class="pre">-n</span></tt> or
<tt class="docutils literal">set <span class="pre">-o</span> noexec</tt> into the script. Note that certain types of syntax
errors can slip past this check.</p>
<p><tt class="docutils literal">sh <span class="pre">-v</span> scriptname</tt> echoes each command before executing it. This is
the equivalent of inserting <tt class="docutils literal">set <span class="pre">-v</span></tt> or
<tt class="docutils literal">set&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="pre">-o</span> verbose</tt> in the script.</p>
<p>The <tt class="docutils literal"><span class="pre">-n</span></tt> and <tt class="docutils literal"><span class="pre">-v</span></tt> flags work well together.
<tt class="docutils literal">sh <span class="pre">-nv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; scriptname</tt> gives a verbose syntax check.</p>
<p><tt class="docutils literal">sh <span class="pre">-x</span> scriptname</tt> echoes the result each command, but in an
abbreviated manner. This is the equivalent of inserting <tt class="docutils literal">set <span class="pre">-x</span></tt> or
<tt class="docutils literal">set <span class="pre">-o</span> xtrace</tt> in the script.</p>
<p>Inserting <tt class="docutils literal">set <span class="pre">-u</span></tt> or <tt class="docutils literal">set <span class="pre">-o</span> nounset</tt> in the script runs it, but
gives an unbound variable error message and aborts the script.</p>
<pre class="literal-block">
set -u   # Or   set -o nounset

# Setting a variable to null will not trigger the error/abort.
# unset_var=

echo $unset_var   # Unset (and undeclared) variable.

echo &quot;Should not echo!&quot;

# sh t2.sh
# t2.sh: line 6: unset_var: unbound variable
</pre>
</li>
<li><p class="first">Using an &quot;assert&quot; function to test a variable or condition at
critical points in a script. (This is an idea borrowed from C.)</p>
<p><strong>Example 32-4. Testing a condition with an *assert*</strong></p>
<pre class="literal-block">
#!/bin/bash
# assert.sh

#######################################################################
assert ()                 #  If condition false,
{                         #+ exit from script
                          #+ with appropriate error message.
  E_PARAM_ERR=98
  E_ASSERT_FAILED=99


  if [ -z &quot;$2&quot; ]          #  Not enough parameters passed
  then                    #+ to assert() function.
    return $E_PARAM_ERR   #  No damage done.
  fi

  lineno=$2

  if [ ! $1 ]
  then
    echo &quot;Assertion failed:  \&quot;$1\&quot;&quot;
    echo &quot;File \&quot;$0\&quot;, line $lineno&quot;    # Give name of file and line number.
    exit $E_ASSERT_FAILED
  # else
  #   return
  #   and continue executing the script.
  fi
} # Insert a similar assert() function into a script you need to debug.
#######################################################################


a=5
b=4
condition=&quot;$a -lt $b&quot;     #  Error message and exit from script.
                          #  Try setting &quot;condition&quot; to something else
                          #+ and see what happens.

assert &quot;$condition&quot; $LINENO
# The remainder of the script executes only if the &quot;assert&quot; does not fail.


# Some commands.
# Some more commands . . .
echo &quot;This statement echoes only if the \&quot;assert\&quot; does not fail.&quot;
# . . .
# More commands . . .

exit $?
</pre>
</li>
<li><p class="first">Using the <a class="reference external" href="internalvariables.html#LINENOREF">$LINENO</a> variable and
the <a class="reference external" href="internal.html#CALLERREF">caller</a> builtin.</p>
</li>
<li><p class="first">Trapping at exit.</p>
<p>The <a class="reference external" href="internal.html#EXITREF">exit</a> command in a script triggers a
signal 0, terminating the process, that is, the script itself.
<a class="reference external" href="debugging.html#FTN.AEN19323">[1]</a> It is often useful to trap the
<em>exit</em>, forcing a &quot;printout&quot; of variables, for example. The <em>trap</em>
must be the first command in the script.</p>
</li>
</ol>
<p><strong>Trapping signals</strong></p>
<dl class="docutils">
<dt><strong>trap</strong></dt>
<dd><p class="first">Specifies an action on receipt of a signal; also useful for
debugging.</p>
<p>A <em>signal</em> is a message sent to a process, either by the kernel or
another process, telling it to take some specified action (usually
to terminate). For example, hitting a
<a class="reference external" href="special-chars.html#CTLCREF">Control-C</a> sends a user interrupt, an
INT signal, to a running program.</p>
<p><em>A simple instance:</em></p>
<pre class="last literal-block">
trap '' 2
# Ignore interrupt 2 (Control-C), with no action specified.

trap 'echo &quot;Control-C disabled.&quot;' 2
# Message when Control-C pressed.
</pre>
</dd>
</dl>
<p><strong>Example 32-5. Trapping at exit</strong></p>
<pre class="literal-block">
#!/bin/bash
# Hunting variables with a trap.

trap 'echo Variable Listing --- a = $a  b = $b' EXIT
#  EXIT is the name of the signal generated upon exit from a script.
#
#  The command specified by the &quot;trap&quot; doesn't execute until
#+ the appropriate signal is sent.

echo &quot;This prints before the \&quot;trap\&quot; --&quot;
echo &quot;even though the script sees the \&quot;trap\&quot; first.&quot;
echo

a=39

b=36

exit 0
#  Note that commenting out the 'exit' command makes no difference,
#+ since the script exits in any case after running out of commands.
</pre>
<p><strong>Example 32-6. Cleaning up after **Control-C**</strong></p>
<pre class="literal-block">
#!/bin/bash
# logon.sh: A quick 'n dirty script to check whether you are on-line yet.

umask 177  # Make sure temp files are not world readable.


TRUE=1
LOGFILE=/var/log/messages
#  Note that $LOGFILE must be readable
#+ (as root, chmod 644 /var/log/messages).
TEMPFILE=temp.$$
#  Create a &quot;unique&quot; temp file name, using process id of the script.
#     Using 'mktemp' is an alternative.
#     For example:
#     TEMPFILE=`mktemp temp.XXXXXX`
KEYWORD=address
#  At logon, the line &quot;remote IP address xxx.xxx.xxx.xxx&quot;
#                      appended to /var/log/messages.
ONLINE=22
USER_INTERRUPT=13
CHECK_LINES=100
#  How many lines in log file to check.

trap 'rm -f $TEMPFILE; exit $USER_INTERRUPT' TERM INT
#  Cleans up the temp file if script interrupted by control-c.

echo

while [ $TRUE ]  #Endless loop.
do
  tail -n $CHECK_LINES $LOGFILE&gt; $TEMPFILE
  #  Saves last 100 lines of system log file as temp file.
  #  Necessary, since newer kernels generate many log messages at log on.
  search=`grep $KEYWORD $TEMPFILE`
  #  Checks for presence of the &quot;IP address&quot; phrase,
  #+ indicating a successful logon.

  if [ ! -z &quot;$search&quot; ] #  Quotes necessary because of possible spaces.
  then
     echo &quot;On-line&quot;
     rm -f $TEMPFILE    #  Clean up temp file.
     exit $ONLINE
  else
     echo -n &quot;.&quot;        #  The -n option to echo suppresses newline,
                        #+ so you get continuous rows of dots.
  fi

  sleep 1
done


#  Note: if you change the KEYWORD variable to &quot;Exit&quot;,
#+ this script can be used while on-line
#+ to check for an unexpected logoff.

# Exercise: Change the script, per the above note,
#           and prettify it.

exit 0


# Nick Drage suggests an alternate method:

while true
  do ifconfig ppp0 | grep UP 1&gt; /dev/null &amp;&amp; echo &quot;connected&quot; &amp;&amp; exit 0
  echo -n &quot;.&quot;   # Prints dots (.....) until connected.
  sleep 2
done

# Problem: Hitting Control-C to terminate this process may be insufficient.
#+         (Dots may keep on echoing.)
# Exercise: Fix this.



# Stephane Chazelas has yet another alternative:

CHECK_INTERVAL=1

while ! tail -n 1 &quot;$LOGFILE&quot; | grep -q &quot;$KEYWORD&quot;
do echo -n .
   sleep $CHECK_INTERVAL
done
echo &quot;On-line&quot;

# Exercise: Discuss the relative strengths and weaknesses
#           of each of these various approaches.
</pre>
<p><strong>Example 32-7. A Simple Implementation of a Progress Bar</strong></p>
<pre class="literal-block">
#! /bin/bash
# progress-bar2.sh
# Author: Graham Ewart (with reformatting by ABS Guide author).
# Used in ABS Guide with permission (thanks!).

# Invoke this script with bash. It doesn't work with sh.

interval=1
long_interval=10

{
     trap &quot;exit&quot; SIGUSR1
     sleep $interval; sleep $interval
     while true
     do
       echo -n '.'     # Use dots.
       sleep $interval
     done; } &amp;         # Start a progress bar as a background process.

pid=$!
trap &quot;echo !; kill -USR1 $pid; wait $pid&quot;  EXIT        # To handle ^C.

echo -n 'Long-running process '
sleep $long_interval
echo ' Finished!'

kill -USR1 $pid
wait $pid              # Stop the progress bar.
trap EXIT

exit $?
</pre>
<div class="figure align-center">
<img alt="Note" src="http://tldp.org/LDP/abs/images/note.gif" />
<p class="caption">Note</p>
</div>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">rst-ca/debugging.ca.rst</tt>, line 452)</p>
Explicit markup ends without a blank line; unexpected unindent.</div>
<p>The <tt class="docutils literal">DEBUG</tt> argument to <strong>trap</strong> causes a specified action to execute
after every command in a script. This permits tracing variables, for
example.</p>
<p><strong>Example 32-8. Tracing a variable</strong></p>
<pre class="literal-block">
#!/bin/bash

trap 'echo &quot;VARIABLE-TRACE&gt; \$variable = \&quot;$variable\&quot;&quot;' DEBUG
# Echoes the value of $variable after every command.

variable=29

echo &quot;  Just initialized \$variable to $variable.&quot;

let &quot;variable *= 3&quot;
echo &quot;  Just multiplied \$variable by 3.&quot;

exit

#  The &quot;trap 'command1 . . . command2 . . .' DEBUG&quot; construct is
#+ more appropriate in the context of a complex script,
#+ where inserting multiple &quot;echo $variable&quot; statements might be
#+ awkward and time-consuming.

# Thanks, Stephane Chazelas for the pointer.


Output of script:

VARIABLE-TRACE&gt; $variable = &quot;&quot;
VARIABLE-TRACE&gt; $variable = &quot;29&quot;
  Just initialized $variable to 29.
VARIABLE-TRACE&gt; $variable = &quot;29&quot;
VARIABLE-TRACE&gt; $variable = &quot;87&quot;
  Just multiplied $variable by 3.
VARIABLE-TRACE&gt; $variable = &quot;87&quot;
</pre>
<p>Of course, the <strong>trap</strong> command has other uses aside from debugging,
such as disabling certain keystrokes within a script (see <a class="reference external" href="contributed-scripts.html#STOPWATCH">Example
A-43</a>).</p>
<p><strong>Example 32-9. Running multiple processes (on an SMP box)</strong></p>
<pre class="literal-block">
#!/bin/bash
# parent.sh
# Running multiple processes on an SMP box.
# Author: Tedman Eng

#  This is the first of two scripts,
#+ both of which must be present in the current working directory.




LIMIT=$1         # Total number of process to start
NUMPROC=4        # Number of concurrent threads (forks?)
PROCID=1         # Starting Process ID
echo &quot;My PID is $$&quot;

function start_thread() {
        if [ $PROCID -le $LIMIT ] ; then
                ./child.sh $PROCID&amp;
                let &quot;PROCID++&quot;
        else
           echo &quot;Limit reached.&quot;
           wait
           exit
        fi
}

while [ &quot;$NUMPROC&quot; -gt 0 ]; do
        start_thread;
        let &quot;NUMPROC--&quot;
done


while true
do

trap &quot;start_thread&quot; SIGRTMIN

done

exit 0



# ======== Second script follows ========


#!/bin/bash
# child.sh
# Running multiple processes on an SMP box.
# This script is called by parent.sh.
# Author: Tedman Eng

temp=$RANDOM
index=$1
shift
let &quot;temp %= 5&quot;
let &quot;temp += 4&quot;
echo &quot;Starting $index  Time:$temp&quot; &quot;$&#64;&quot;
sleep ${temp}
echo &quot;Ending $index&quot;
kill -s SIGRTMIN $PPID

exit 0


# ======================= SCRIPT AUTHOR'S NOTES ======================= #
#  It's not completely bug free.
#  I ran it with limit = 500 and after the first few hundred iterations,
#+ one of the concurrent threads disappeared!
#  Not sure if this is collisions from trap signals or something else.
#  Once the trap is received, there's a brief moment while executing the
#+ trap handler but before the next trap is set.  During this time, it may
#+ be possible to miss a trap signal, thus miss spawning a child process.

#  No doubt someone may spot the bug and will be writing
#+ . . . in the future.



# ===================================================================== #



# ----------------------------------------------------------------------#



#################################################################
# The following is the original script written by Vernia Damiano.
# Unfortunately, it doesn't work properly.
#################################################################

#!/bin/bash

#  Must call script with at least one integer parameter
#+ (number of concurrent processes).
#  All other parameters are passed through to the processes started.


INDICE=8        # Total number of process to start
TEMPO=5         # Maximum sleep time per process
E_BADARGS=65    # No arg(s) passed to script.

if [ $# -eq 0 ] # Check for at least one argument passed to script.
then
  echo &quot;Usage: `basename $0` number_of_processes [passed params]&quot;
  exit $E_BADARGS
fi

NUMPROC=$1              # Number of concurrent process
shift
PARAMETRI=( &quot;$&#64;&quot; )      # Parameters of each process

function avvia() {
         local temp
         local index
         temp=$RANDOM
         index=$1
         shift
         let &quot;temp %= $TEMPO&quot;
         let &quot;temp += 1&quot;
         echo &quot;Starting $index Time:$temp&quot; &quot;$&#64;&quot;
         sleep ${temp}
         echo &quot;Ending $index&quot;
         kill -s SIGRTMIN $$
}

function parti() {
         if [ $INDICE -gt 0 ] ; then
              avvia $INDICE &quot;${PARAMETRI[&#64;]}&quot; &amp;
                let &quot;INDICE--&quot;
         else
                trap : SIGRTMIN
         fi
}

trap parti SIGRTMIN

while [ &quot;$NUMPROC&quot; -gt 0 ]; do
         parti;
         let &quot;NUMPROC--&quot;
done

wait
trap - SIGRTMIN

exit $?

: &lt;&lt;SCRIPT_AUTHOR_COMMENTS
I had the need to run a program, with specified options, on a number of
different files, using a SMP machine. So I thought [I'd] keep running
a specified number of processes and start a new one each time . . . one
of these terminates.

The &quot;wait&quot; instruction does not help, since it waits for a given process
or *all* process started in background. So I wrote [this] bash script
that can do the job, using the &quot;trap&quot; instruction.
  --Vernia Damiano
SCRIPT_AUTHOR_COMMENTS
</pre>
<div class="figure align-center">
<img alt="Note" src="http://tldp.org/LDP/abs/images/note.gif" />
<p class="caption">Note</p>
</div>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">rst-ca/debugging.ca.rst</tt>, line 666)</p>
Explicit markup ends without a blank line; unexpected unindent.</div>
<p><tt class="docutils literal">trap '' SIGNAL</tt> (two adjacent apostrophes) disables SIGNAL for the
remainder of the script. <tt class="docutils literal">trap SIGNAL</tt> restores the functioning of
SIGNAL once more. This is useful to protect a critical portion of a
script from an undesirable interrupt.</p>
<pre class="literal-block">
trap '' 2  # Signal 2 is Control-C, now disabled.
 command
 command
 command
 trap 2     # Reenables Control-C
</pre>
<p><a class="reference external" href="bashver3.html#BASH3REF">Version 3</a> of Bash adds the following
<a class="reference external" href="internalvariables.html#INTERNALVARIABLES1">internal variables</a> for
use by the debugger.</p>
<ol class="arabic">
<li><p class="first"><tt class="docutils literal">$BASH_ARGC</tt></p>
<p>Number of command-line arguments passed to script, similar to
<tt class="docutils literal">`$#</tt> &lt;internalvariables.html#CLACOUNTREF&gt;`_.</p>
</li>
<li><p class="first"><tt class="docutils literal">$BASH_ARGV</tt></p>
<p>Final command-line parameter passed to script, equivalent
<tt class="docutils literal"><span class="pre">`${!#}</span></tt> &lt;othertypesv.html#LASTARGREF&gt;`_.</p>
</li>
<li><p class="first"><tt class="docutils literal">$BASH_COMMAND</tt></p>
<p>Command currently executing.</p>
</li>
<li><p class="first"><tt class="docutils literal">$BASH_EXECUTION_STRING</tt></p>
<p>The <em>option string</em> following the <tt class="docutils literal"><span class="pre">-c</span></tt>
<a class="reference external" href="bash-options.html#CLOPTS">option</a> to Bash.</p>
</li>
<li><p class="first"><tt class="docutils literal">$BASH_LINENO</tt></p>
<p>In a <a class="reference external" href="functions.html#FUNCTIONREF">function</a>, indicates the line
number of the function call.</p>
</li>
<li><p class="first"><tt class="docutils literal">$BASH_REMATCH</tt></p>
<p>Array variable associated with <strong>=~</strong> <a class="reference external" href="bashver3.html#REGEXMATCHREF">conditional regex
matching</a>.</p>
</li>
<li><p class="first"><tt class="docutils literal">$BASH_SOURCE</tt></p>
<p>This is the name of the script, usually the same as
<a class="reference external" href="othertypesv.html#ARG0">$0</a>.</p>
</li>
<li><p class="first"><tt class="docutils literal">`$BASH_SUBSHELL</tt> &lt;internalvariables.html#BASHSUBSHELLREF&gt;`_</p>
</li>
</ol>
<div class="section" id="notes">
<h2>Notes</h2>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">rst-ca/debugging.ca.rst</tt>, line 10); <em><a href="#id5">backlink</a></em></p>
Duplicate explicit target name: &quot;[1]&quot;.</div>
<p><a class="reference external" href="debugging.html#AEN19323">[1]</a></p>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">rst-ca/debugging.ca.rst</tt>, line 10); <em><a href="#id6">backlink</a></em></p>
Duplicate explicit target name: &quot;exit&quot;.</div>
<p>By convention, <tt class="docutils literal">signal&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0</tt> is assigned to
<a class="reference external" href="exit-status.html#EXITCOMMANDREF">exit</a>.</p>
<hr class="docutils" />
<table border="1" class="docutils">
<colgroup>
<col width="32%" />
<col width="32%" />
<col width="35%" />
</colgroup>
<tbody valign="top">
<tr><td><a class="reference external" href="zeros.html">Prev</a></td>
<td><a class="reference external" href="index.html">Home</a></td>
<td><a class="reference external" href="options.html">Next</a></td>
</tr>
<tr><td>Of Zeros and Nulls</td>
<td><a class="reference external" href="part5.html">Up</a></td>
<td>Options</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</body>
</html>
